---
const { title = 'TransCrab', description } = Astro.props;
---
<html lang="zh-Hans">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    {description ? <meta name="description" content={description} /> : null}

    <link rel="icon" href="/favicon-32.png" sizes="32x32" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180" />

    <!-- Code highlight themes -->
    <!-- Light mode: keep it subtle and let our own <pre> background show through -->
    <link rel="stylesheet" href="/hljs/github.css" media="(prefers-color-scheme: light)" />
    <!-- Dark mode: Kanagawabones-inspired (transparent background) -->
    <link rel="stylesheet" href="/hljs/kanagawabones.css" media="(prefers-color-scheme: dark)" />

    <style is:global>
      :root {
        color-scheme: light dark;
        --page-max: 900px;
        --text-max: 760px;
      }

      body {
        font-family: ui-sans-serif, system-ui, -apple-system;
        margin: 2.2rem auto;
        max-width: var(--page-max);
        padding: 0 1.25rem;
        line-height: 1.85;
        text-rendering: optimizeLegibility;
        -webkit-font-smoothing: antialiased;
      }

      /* Better Chinese + Latin spacing when supported */
      article {
        max-width: var(--text-max);
        text-spacing: auto;
      }

      a { color: inherit; }
      a.footer-link { color: rgba(60, 140, 210, .85); text-decoration: none; }
      a.footer-link:hover { text-decoration: underline; }

      h1 { line-height: 1.25; margin: 0 0 0.5rem 0; }
      h2, h3 { line-height: 1.35; margin-top: 2rem; }

      p { margin: 0.85rem 0; }
      ul, ol { padding-left: 1.4rem; }
      li { margin: 0.25rem 0; }

      pre {
        padding: 0.9rem 1rem;
        border-radius: 10px;
        overflow: auto;
        line-height: 1.6;
        border: 1px solid rgba(127,127,127,.22);
        background: rgba(127,127,127,.08);
      }

      code {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 0.95em;
      }

      /* Images */
      article img {
        max-width: 100%;
        height: auto;
        border-radius: 10px;
      }
      article a.img-zoom {
        display: inline-block;
        cursor: zoom-in;
      }

      /* Blockquotes */
      blockquote {
        margin: 1.2rem 0;
        padding: 0.25rem 0 0.25rem 1rem;
        border-left: 4px solid rgba(127,127,127,.35);
        opacity: .92;
      }
      blockquote p { margin: .6rem 0; }

      /* Image modal */
      .img-modal {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(0,0,0,.72);
        z-index: 9999;
        padding: 2rem;
      }
      .img-modal.open { display: flex; }
      .img-modal img {
        max-width: min(92vw, 1200px);
        max-height: 88vh;
        width: auto;
        height: auto;
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0,0,0,.35);
        cursor: zoom-out;
      }
      .img-modal .hint {
        position: fixed;
        bottom: 16px;
        left: 50%;
        transform: translateX(-50%);
        font-size: 12px;
        opacity: .75;
      }

      hr { border: none; border-top: 1px solid rgba(127,127,127,.25); margin: 2rem 0; }

      .meta { opacity: .72; font-size: .92rem; margin-top: .25rem; }
      .nav a { margin-right: .75rem; }
      .nav { margin-bottom: 0.75rem; }

      /* Brand */
      h1.brand {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      h1.brand > span {
        margin-left: 2px;
      }
      img.brand-mark {
        width: 1.05em;
        height: 1.05em;
        flex: 0 0 1.05em;
        transform: translateY(1.5px);
      }

      footer {
        margin-top: 3rem;
        padding-top: 1.25rem;
        border-top: 1px solid rgba(127,127,127,.18);
        opacity: .6;
        font-size: .85rem;
      }
    </style>
  </head>
  <body>
    <slot />

    <div class="img-modal" id="img-modal" role="dialog" aria-modal="true" aria-hidden="true">
      <img id="img-modal-img" alt="" />
      <div class="hint">Click / ESC to close</div>
    </div>

    <footer>
      Made with ❤️ by <a class="footer-link" href="https://x.com/onevcat" target="_blank" rel="noreferrer">@onevcat</a>.
    </footer>

    <script type="module">
      import pangu from 'https://esm.sh/pangu@7.2.0';
      // Add spacing between CJK and half-width chars (per Chinese copywriting guidelines).
      // Run after render to avoid fighting with markdown.
      try {
        pangu.spacingElementByElement(document.body);
      } catch {}

      // Code highlighting (client-side)
      // Theme is loaded via CSS (see <head>).
      try {
        // Use an ESM loader for browser execution. (Bare specifiers like "highlight.js" won't resolve in the browser.)
        const { default: hljs } = await import('https://esm.sh/highlight.js@11.9.0');

        // If a block declares a language (```swift), respect it.
        // Otherwise do NOT auto-detect to avoid random languages like abnf/apache/maxima.
        for (const el of document.querySelectorAll('pre code')) {
          const cls = el.className || '';
          const m = cls.match(/language-([a-z0-9_+-]+)/i);
          if (m) {
            const lang = m[1].toLowerCase();
            if (hljs.getLanguage(lang)) {
              hljs.highlightElement(el);
              continue;
            }
          }
          // No (valid) language specified: just apply baseline styling.
          // This prevents noisy autodetection.
          el.classList.add('hljs');
        }
      } catch {}

      // Image zoom modal
      const modal = document.getElementById('img-modal');
      const modalImg = document.getElementById('img-modal-img');
      function closeModal() {
        modal?.classList.remove('open');
        modal?.setAttribute('aria-hidden', 'true');
        if (modalImg) modalImg.src = '';
      }
      function openModal(src) {
        if (!modal || !modalImg) return;
        modalImg.src = src;
        modal.classList.add('open');
        modal.setAttribute('aria-hidden', 'false');
      }

      // Wrap article images with a zoomable anchor
      for (const img of document.querySelectorAll('article img')) {
        if (!img.src) continue;
        const a = document.createElement('a');
        a.href = img.src;
        a.className = 'img-zoom';
        a.addEventListener('click', (e) => {
          e.preventDefault();
          openModal(img.src);
        });
        img.parentNode?.insertBefore(a, img);
        a.appendChild(img);
      }

      modal?.addEventListener('click', closeModal);
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeModal();
      });
    </script>
  </body>
</html>
